var APIConnection=function(){this.DEBUG=!0;this.ADVANCED_DEBUG=!1;this.wsUri="";this.state_changed_handler=this.response_received_handler=null;this.response_received_handlers=[];this.state_changed_handlers=[];this.response_received_handlers_missing=function(){return null!=this.response_received_handler||0<this.response_received_handlers.length?!1:!0};this.state_changed_handlers_missing=function(){return null!=this.state_changed_handler||0<this.state_changed_handlers.length?!1:!0};this.response_received_handlers_add=
function(a){if("function"!=typeof a)return a;this.response_received_handlers_remove(a);this.response_received_handlers.push(a);return a};this.state_changed_handlers_add=function(a){if("function"!=typeof a)return a;this.state_changed_handlers_remove(a);this.state_changed_handlers.push(a);return a};this.response_received_handlers_remove=function(a){if("function"!=typeof a)return a;for(var b=this.response_received_handlers.length-1;0<=b&&this.response_received_handlers[b]!==a;)b--;return 0<=b?this.response_received_handlers.splice(b,
1):null};this.state_changed_handlers_remove=function(a){if("function"!=typeof a)return a;for(var b=this.state_changed_handlers.length-1;0<=b&&this.state_changed_handlers[b]!==a;)b--;return 0<=b?this.state_changed_handlers.splice(b,1):null};this.response_received_handlers_call=function(a){if(!this.response_received_handler||!this.response_received_handler(a))for(var b=this.response_received_handlers.length-1;0<=b&&!this.response_received_handlers[b](a);)b--};this.state_changed_handlers_call=function(){if(!this.state_changed_handler||
!this.state_changed_handler())for(var a=this.state_changed_handlers.length-1;0<=a&&!this.state_changed_handlers[a]();)a--};this.login_passwd=this.login_name="";this.registration=this.credential_data=null;this.version=function(){return"126"};this.is_logged_in=function(){return"IN_SESSION"==this.conn_state};this.clog=function(a){this.DEBUG&&console.log((new Date).toLocaleTimeString()+": "+a)};this.pretty=function(a){return JSON.stringify(JSON.parse(a),null,2)};var e=function(a,b){return function(){return a.apply(b,
arguments)}};this.getUnixTime=function(){return Math.round((new Date).getTime()/1E3)};this.url2hex=function(a){var b=a.indexOf("//");if(-1==b)return a;var d=a.substring(b+2).indexOf("/");if(-1==d)return a;var c=a.substring(0,b+2+d+1);b=a.substring(b+2).substring(d+1);if(""==b)return a;a=unescape(encodeURIComponent(b));b="";for(d=0;d<a.length;d++)b+=a.charCodeAt(d).toString(16);return c+"__"+b};this.not_empty=function(a,b){return"undefined"===typeof a[b]||void 0===a[b]||""===a[b]||null===a[b]?!1:!0};
this.sess="";this.user_info={};this.server_info={};this.user_data={};this.user_joread=function(){var a=localStorage.getItem("sdk_user_jowrite_json_string");if(null==a||""==a)a="{}";return JSON.parse(a)};this.user_jowrite=function(a){a=JSON.stringify(a);localStorage.setItem("sdk_user_jowrite_json_string",a)};this.client_info={};this.user_pref={};this.user_pref.perf_enabled="true";this.response=null;this.req_queue_after_connect=[];this.req_queue_after_login=[];this.MAX_RESPONSE_TIME=15;this.MINDER_TIME=
30;this.NETWORK_RETRY_TIMER=2;this.NETWORK_RETRY_FAILURE_COUNTER=0;this.network_retry_timer_value=function(){if(5<this.NETWORK_RETRY_FAILURE_COUNTER)return 15*this.NETWORK_RETRY_TIMER;this.NETWORK_RETRY_FAILURE_COUNTER++;return this.NETWORK_RETRY_TIMER};this.network_retry_failure_counter_reset=function(){this.NETWORK_RETRY_FAILURE_COUNTER=0};this.MAX_CONNECTING_TIME=5;this.last_connecting=0;this.GUEST_SEND_KEEPALIVE_TIME=30;this.credential=function(a,b){this.login_name=a;this.login_passwd=b;this.registration=
this.user_info=this.credential_data=null;this.target_state="INITIAL_LOGIN"};this.credentialx=function(a){this.login_passwd=this.login_name="";this.credential_data=a;this.registration=this.user_info=null;this.target_state="INITIAL_LOGIN"};this.send_str=function(a){a=JSON.parse(a);return this.send_obj(a)};this.reset_websocket_conn=function(){this.clog("reset_websocket_conn: websocket:"+(null==this.websocket?"null":this.websocket));null!=this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=
null,this.websocket.onmessage=null,this.websocket.close());this.websocket=null};this.revert_and_reset_state=function(){this.clog("revert_and_reset_state: from_state:"+this.from_state+" state:"+this.conn_state);"CONNECTING"==this.conn_state&&(this.conn_state=this.from_state);"SESSION_LOGIN"==this.conn_state&&(this.conn_state="IN_SESSION",this.target_state="SESSION_LOGIN");"REGISTRATION"==this.conn_state&&(this.conn_state="LOGIN_SCREEN_ENABLED",this.target_state="REGISTRATION");"INITIAL_LOGIN"==this.conn_state&&
(this.conn_state="LOGIN_SCREEN_ENABLED",this.target_state="INITIAL_LOGIN");"SERVERINFO_REQ"==this.conn_state&&(this.conn_state="LOGIN_SCREEN_SHOWN",this.target_state="SERVERINFO_REQ")};this.wsconn_and_state_sanity_check=function(){if("LOGIN_SCREEN_SHOWN"==this.conn_state)this.clog("wsconn_and_state_sanity_check: LOGIN_SCREEN_SHOWN, it appears it is restarted"),this.target_state="SERVERINFO_REQ",this.reset_websocket_conn(),this.connect();else{var a=this.getUnixTime();"CONNECTING"==this.conn_state&&
a-this.last_connecting>this.MAX_CONNECTING_TIME&&(this.revert_and_reset_state(),this.reset_websocket_conn());if("IN_SESSION"==this.conn_state){var b=180;null!=this.server_info&&0<this.server_info.web_app_ping&&(b=this.server_info.web_app_ping);this.last_resp<this.last_ping&&a-this.last_ping>this.MAX_RESPONSE_TIME&&(this.revert_and_reset_state(),this.reset_websocket_conn());a-this.last_resp>2*b&&(this.revert_and_reset_state(),this.reset_websocket_conn())}}};this.send_obj=function(a){if("person"==a.obj&&
("login"==a.act||"logout"==a.act||"register"==a.act))return this.clog("send_obj: not authorized to call login/logout/register direct, request ignored"),!1;"IN_SESSION"==this.conn_state||"SESSION_LOGIN"==this.conn_state||"CONNECTING"==this.conn_state&&"IN_SESSION"==this.from_state?this.req_queue_after_login.push(a):this.req_queue_after_connect.push(a);if("LOGIN_SCREEN_ENABLED"==this.conn_state&&null!=this.websocket&&this.getUnixTime()-this.last_resp<this.GUEST_SEND_KEEPALIVE_TIME)return this.send_all_after_connect();
this.wsconn_and_state_sanity_check();return"LOGIN_SCREEN_ENABLED"==this.conn_state?(this.reset_websocket_conn(),this.target_state="GUEST_SEND",this.connect(),!0):"IN_SESSION"==this.conn_state?null==this.websocket?(this.clog("send: websocket is null, from_state: "+this.from_state+"  state: "+this.conn_state),this.target_state="SESSION_LOGIN",this.connect(),!0):this.send_all_after_login():!0};this.send_all_after_login=function(){for(;0<this.req_queue_after_login.length;){if("server"==this.req_queue_after_login[0].obj){var a=
this.req_queue_after_login[0].act,b=this.getUnixTime();if(("pinw"==a||"ping"==a)&&5>b-this.last_resp){this.req_queue_after_login.shift();continue}}if(this.send_obj_now(this.req_queue_after_login[0]))this.req_queue_after_login.shift();else return!1}return!0};this.send_all_after_connect=function(){for(;0<this.req_queue_after_connect.length;){if("server"==this.req_queue_after_connect[0].obj){var a=this.req_queue_after_connect[0].act,b=this.getUnixTime();if(("pinw"==a||"ping"==a)&&5>b-this.last_resp){this.req_queue_after_connect.shift();
continue}}if(this.send_obj_now(this.req_queue_after_connect[0]))this.req_queue_after_connect.shift();else return!1}return!0};this.send_obj_now=function(a){if(null==a)return!1;this.not_empty(a,"sess")||(a.sess=this.sess);this.not_empty(a,"io")||(a.io="i");"true"==this.user_pref.perf_enabled&&(a.perf=1);if(!this.not_empty(a,"client_info")&&null!=this.client_info&&0<Object.keys(this.client_info).length){"IN_SESSION"!=this.conn_state?this.client_info.state=this.conn_state:delete this.client_info.state;
var b="",d="",c=/(i\d\d\d)/;"undefined"!==typeof StackTrace&&StackTrace.getSync().forEach(function(a){if(""==b){var e=c.exec(a.fileName);null!=e&&(b=e[1])}""==d&&0>a.fileName.indexOf("APIConnection")&&(d=a.fileName,0<=d.lastIndexOf("/")&&(d=d.substring(d.lastIndexOf("/")+1)),0<=d.indexOf(".")&&(d=d.substring(0,d.indexOf("."))))});""!=b?this.client_info.caller=b:""!=d&&(this.client_info.caller=d);a.client_info=this.client_info}"person"!=a.obj||"login"!=a.act&&"logout"!=a.act&&"register"!=a.act||(this.sess=
"");a=JSON.stringify(a)+"\n";this.clog(a);this.last_ping=this.getUnixTime();this.websocket.send(a);return!0};this.set_state=function(a,b){this.from_state=this.conn_state;this.conn_state=a;this.ADVANCED_DEBUG&&this.clog("set_state: "+this.from_state+" => "+this.conn_state);b&&this.state_changed_handlers_call()};this.onConnectionOpen=function(a){this.clog("onConnectionOpen:"+a.data);this.network_retry_failure_counter_reset();"SERVERINFO_REQ"==this.target_state?this.req_server_info():"INITIAL_LOGIN"==
this.target_state?this.login_(!0):"SESSION_LOGIN"==this.target_state?this.login_(!1):"REGISTRATION"==this.target_state?this.send_registration():"GUEST_SEND"==this.target_state&&(this.conn_state="LOGIN_SCREEN_ENABLED",this.send_all_after_connect())};this.onConnectionClose=function(a){this.clog("onConnectionClose:"+a.data);this.reset_websocket_conn();this.revert_and_reset_state();window.setTimeout(e(this.connect,this),1E3*this.network_retry_timer_value())};this.onConnectionMessage=function(a){this.last_resp=
this.getUnixTime();a=a.data.replace(/[\s\r\n]+$/,"").split("\n");a.splice(0,1);this.clog(this.pretty("["+a.join(",")+"]"));a=JSON.parse("["+a.join(",")+"]");for(var b=0,d=a.length;b<d;b++){var c=a[b];this.not_empty(c,"sess")&&(this.sess=c.sess);this.not_empty(c,"sessreset")&&c.sessreset==this.sess&&"IN_SESSION"==this.conn_state&&this.login_(!1);if("server"!=c.obj||"ping"!=c.act&&"pinw"!=c.act){"server"==c.obj&&"info"==c.act&&(this.server_info=c.server_info,"SERVERINFO_REQ"==this.conn_state&&c.server_info&&
this.set_state("LOGIN_SCREEN_ENABLED",!0));if("person"==c.obj&&"login"==c.act||"person"==c.obj&&"register"==c.act)c.user_info&&(this.user_info=c.user_info),c.server_info&&(this.server_info=c.server_info),""!=this.sess?("REGISTRATION"==this.conn_state&&(this.login_name=this.registration.login_name,this.login_passwd=this.registration.login_passwd,this.credential_data=this.registration.credential_data,this.registration=null),"INITIAL_LOGIN"==this.conn_state||"REGISTRATION"==this.conn_state?this.set_state("IN_SESSION",
!0):this.set_state("IN_SESSION",!1),this.send_all_after_login()):(this.registration=this.user_info=null,this.login_passwd=this.login_name="",this.credential_data=null,"REGISTRATION"==this.conn_state?this.set_state("LOGIN_SCREEN_ENABLED",!1):this.set_state("LOGIN_SCREEN_ENABLED",!0));"person"==c.obj&&"logout"==c.act&&(this.user_info=null,this.login_passwd=this.login_name=this.sess="",this.credential_data=null,this.reset_websocket_conn(),this.set_state("LOGIN_SCREEN_ENABLED",!0));"sdk"==c.obj&&"logreq"==
c.act&&this.sdk_logsend(c.from_pid);"sdk"==c.obj&&"user_data"==c.act&&(null==c.data?this.sdk_userdatasend(c.from_pid):this.user_data=c.data);"sdk"==c.obj&&"user_joread"==c.act&&this.sdk_joreadsend(c.from_pid,this.user_joread());"sdk"==c.obj&&"user_jowrite"==c.act&&this.user_jowrite(c.data);this.response=c;this.response_received_handlers_call(c)}}};this.onConnectionError=function(a){this.clog("onConnectionError:"+a.data);this.reset_websocket_conn();this.revert_and_reset_state();window.setTimeout(e(this.connect,
this),1E3*this.network_retry_timer_value())};this.connect=function(){this.response_received_handlers_missing()?this.clog("connect: response_received_handler or response_received_handlers missing, connect ignored"):this.state_changed_handlers_missing()?this.clog("connect: state_changed_handler or state_changed_handlers missing, connect ignored"):"CONNECTING"==this.conn_state?this.clog("connect: already connecting, connect request is ignored"):("LOGIN_SCREEN_ENABLED"==this.conn_state&&null!=this.registration&&
(this.target_state="REGISTRATION",this.reset_websocket_conn()),"INITIAL_LOGIN"!=this.target_state||null!=this.login_name&&""!=this.login_name||null!=this.credential_data?(this.last_connecting=this.getUnixTime(),this.set_state("CONNECTING",!1),this.clog("websocket create: wsUri:"+this.wsUri+" from_state:"+this.from_state+" state:"+this.conn_state),this.websocket=new WebSocket(this.wsUri),this.websocket.onopen=e(this.onConnectionOpen,this),this.websocket.onclose=e(this.onConnectionClose,this),this.websocket.onerror=
e(this.onConnectionError,this),this.websocket.onmessage=e(this.onConnectionMessage,this)):this.logout_())};this.login=function(a,b){this.credential(a,b);this.connect()};this.loginx=function(a){this.credentialx(a);this.connect()};this.logout=function(){this.credential("","");this.connect()};this.register=function(a){this.registration=a;this.connect()};this.login_=function(a){if(null!=this.credential_data||""!=this.login_name)if(null!=this.credential_data||""!=this.login_passwd){var b={obj:"person",
act:"login"};a&&(b.sdk_version_webapp=this.version());null==this.credential_data?(b.login_name=this.login_name,b.login_passwd=this.login_passwd):b.credential_data=this.credential_data;a&&(b.verbose=1);if(null==this.user_info||0==Object.keys(this.user_info).length)b.verbose=1;a?this.set_state("INITIAL_LOGIN",!0):this.set_state("SESSION_LOGIN",!1);this.send_obj_now(b)}};this.logout_=function(){""!=this.sess&&(this.set_state("LOGIN_SCREEN_ENABLED"),this.send_obj_now({obj:"person",act:"logout"}))};this.send_registration=
function(){null!=this.registration&&(this.login_passwd=this.login_name=this.sess="",this.credential_data=null,this.registration.obj="person",this.registration.act="register",this.set_state("REGISTRATION",!0),this.send_obj_now(this.registration))};this.ping=function(){this.send_obj_now({obj:"server",act:"pinw"})};this.req_server_info=function(){this.set_state("SERVERINFO_REQ",!0);this.send_obj_now({obj:"server",act:"info",sdk:this.version()})};this.log_strings=[];this.log_total_len=0;this.log_add=
function(a){this.log_strings.push(a);for(this.log_total_len+=a.length;10240<this.log_total_len;)a=this.log_strings.shift(),this.log_total_len-=a.length};this.log_extra=function(){return""};this.sdk_logsend=function(a){this.send_obj_now({obj:"sdk",act:"logsend",to_pid:a,version:this.version(),data:this.log_strings.join("\n"),extra:this.log_extra()})};this.sdk_userdatasend=function(a){this.send_obj_now({obj:"sdk",act:"logsend",to_pid:a,data:this.user_data})};this.sdk_joreadsend=function(a,b){this.send_obj_now({obj:"sdk",
act:"logsend",to_pid:a,data:b})};this.last_ping=0;this.websocket=null;this.from_state=this.conn_state="LOGIN_SCREEN_SHOWN";this.target_state="SERVERINFO_REQ";this.minder=function(){if(("LOGIN_SCREEN_SHOWN"==this.conn_state||"LOGIN_SCREEN_ENABLED"==this.conn_state)&&(""!=this.login_name&&""!=this.login_passwd||null!=this.credential_data))this.connect();else if("IN_SESSION"==this.conn_state){var a=this.getUnixTime(),b=180;null!=this.server_info&&null!=this.server_info.web_app_ping&&0<this.server_info.web_app_ping&&
(b=this.server_info.web_app_ping);this.last_resp<this.last_ping&&a-this.last_ping>this.MAX_RESPONSE_TIME?(this.reset_websocket_conn(),window.setTimeout(e(this.connect,this),1E3*this.network_retry_timer_value())):a-this.last_ping>=b&&(this.clog("connection_minder ping initiated"),this.ping())}window.setTimeout(e(this.minder,this),1E3*this.MINDER_TIME)};window.setTimeout(e(this.minder,this),1E3*this.MINDER_TIME);this.clog("APIConnection init at unixtime: "+this.getUnixTime()+" version: "+this.version())};